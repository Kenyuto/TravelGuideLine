# Feature Specification: 行程卡片購買清單

**Feature**: `002-shopping-list`  
**Created**: 2025-12-18  
**Status**: Draft  
**Input**: 多人共用行程的購買清單功能，支援即時同步、離線操作和協作管理

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 快速勾選購買項目 (Priority: P1)

單一使用者在行程地點卡片中快速新增購買項目並勾選完成狀態，系統即時保存狀態，確保重新整理後狀態不會遺失。

**Why this priority**: 這是最核心的使用場景，讓使用者能夠在旅遊現場快速記錄要購買的項目並追蹤完成狀態。沒有這個功能，購買清單就無法運作。

**Independent Test**: 使用者可以在任一行程卡片中新增「要買的伴手禮」項目，勾選完成後重新整理頁面，狀態仍然保留。

**Acceptance Scenarios**:

1. **Given** 使用者開啟某一行程卡片（如「台北101」）  
   **When** 點擊「新增購買項目」並輸入「鳳梨酥」  
   **Then** 項目立即出現在購買清單中，狀態為「未完成」

2. **Given** 購買清單中有一個「未完成」的項目「鳳梨酥」  
   **When** 點擊該項目文字或勾選框  
   **Then** 項目標示為「已完成」，並有視覺回饋（如刪除線、變灰、移到清單底部）

3. **Given** 使用者已勾選「鳳梨酥」為「已完成」  
   **When** 重新整理頁面或重新登入  
   **Then** 「鳳梨酥」仍顯示為「已完成」狀態

4. **Given** 購買清單中有多個項目  
   **When** 使用者選擇「僅顯示未完成」檢視模式  
   **Then** 只顯示未勾選的購買項目，已完成項目隱藏

---

### User Story 2 - 多人協作同步 (Priority: P1)

多位行程成員能同時查看和更新購買清單，任一成員的操作會即時反映在其他成員的畫面上。

**Why this priority**: 這是「多人共用行程」的核心價值，讓團隊成員能協作管理購買事項，避免重複購買或遺漏。

**Independent Test**: 兩位使用者同時登入同一行程，當 A 勾選「茶葉」為已購買時，B 的畫面應在數秒內自動更新顯示「茶葉」已完成。

**Acceptance Scenarios**:

1. **Given** 使用者 A 和使用者 B 同時開啟「故宮博物院」行程卡片  
   **When** 使用者 A 新增購買項目「青花瓷紀念品」  
   **Then** 使用者 B 的畫面在 3 秒內自動顯示該新項目

2. **Given** 使用者 A 和使用者 B 都看到未完成的項目「明信片」  
   **When** 使用者 A 勾選「明信片」為已完成  
   **Then** 使用者 B 的畫面在 3 秒內自動更新，「明信片」顯示為已完成

3. **Given** 使用者 A 和使用者 B 幾乎同時勾選同一項目「鑰匙圈」  
   **When** 兩人的操作時間差距不到 1 秒  
   **Then** 系統以最後一次操作（時間戳較新）的狀態為準，兩人最終看到一致的狀態

4. **Given** 購買項目「手工皂」的最後更新資訊  
   **When** 使用者查看該項目詳情  
   **Then** 顯示「最後更新：使用者 A，2025-12-18 14:30」

---

### User Story 3 - 詳細項目資訊管理 (Priority: P2)

使用者能為購買項目添加詳細資訊（數量、預估金額、備註），幫助更精確地管理購買清單。

**Why this priority**: 提供更完整的購買管理功能，但基礎的勾選功能已足夠應付大部分使用場景，因此優先級略低。

**Independent Test**: 使用者新增「綠茶」項目時，可填寫「數量：3 盒」、「預估金額：NT$ 450」、「備註：送給辦公室同事」，資訊完整保存並顯示。

**Acceptance Scenarios**:

1. **Given** 使用者正在新增購買項目  
   **When** 填寫項目名稱「太陽餅」、數量「5 盒」、預估金額「300」、備註「給親戚」  
   **Then** 項目完整顯示所有資訊，金額自動加上幣別符號「NT$ 300」

2. **Given** 已存在的購買項目「牛軋糖」  
   **When** 點擊編輯按鈕，修改數量從「2 盒」改為「3 盒」  
   **Then** 項目更新為新數量，並標記最後更新時間

3. **Given** 購買清單中有多個項目含金額  
   **When** 使用者查看卡片購買清單  
   **Then** 底部顯示「預估總金額：NT$ 1,250」

---

### User Story 4 - 離線操作支援 (Priority: P2)

使用者在網路不穩定或離線狀態下仍可勾選購買項目，網路恢復後自動同步至伺服器。

**Why this priority**: 旅遊現場常遇到網路不佳情況，離線支援能大幅提升使用體驗，但不影響功能基本運作。

**Independent Test**: 使用者關閉網路後勾選「手機殼」為已完成，重新連線後該狀態自動同步給其他成員。

**Acceptance Scenarios**:

1. **Given** 使用者正在使用購買清單，網路突然中斷  
   **When** 勾選「耳機」為已完成  
   **Then** 本地畫面立即更新為已完成，並顯示「離線模式，將於連線後同步」

2. **Given** 使用者在離線狀態下勾選了 3 個項目  
   **When** 網路恢復連線  
   **Then** 系統自動將 3 個項目的狀態同步至伺服器，並通知其他成員

3. **Given** 使用者 A 離線勾選「相機」為已完成，使用者 B 在線上同時勾選「相機」為未完成  
   **When** 使用者 A 恢復連線  
   **Then** 系統比對時間戳，採用較新的操作結果，並顯示「已與伺服器同步，採用最新狀態」

---

### User Story 5 - 權限與角色管理 (Priority: P3)

行程擁有者和參與者有不同的購買清單管理權限，確保資料安全和管理彈性。

**Why this priority**: 權限管理是進階功能，適合有明確管理需求的團隊，但大部分場景下所有成員平等協作即可。

**Independent Test**: 行程擁有者可以刪除任何購買項目，但一般參與者只能刪除自己新增的項目。

**Acceptance Scenarios**:

1. **Given** 使用者 A 是行程擁有者，使用者 B 是參與者  
   **When** 使用者 A 和 B 都新增購買項目  
   **Then** 兩人都能看到彼此新增的項目，並都能勾選完成狀態

2. **Given** 使用者 B（參與者）新增了「明信片」  
   **When** 使用者 B 嘗試刪除自己新增的「明信片」  
   **Then** 成功刪除，並提示「已刪除購買項目」

3. **Given** 使用者 A（擁有者）想刪除使用者 B 新增的「明信片」  
   **When** 使用者 A 點擊刪除按鈕  
   **Then** 成功刪除，並記錄「由擁有者 A 刪除」

4. **Given** 系統管理員想新增更多角色（如「僅檢視者」）  
   **When** 管理員配置新角色權限  
   **Then** 系統架構支援擴充，無需大幅修改代碼

---

### User Story 6 - 行程複製與資料保留 (Priority: P3)

行程結束後，購買清單紀錄完整保留；複製行程時可選擇是否清空勾選狀態。

**Why this priority**: 這是輔助功能，適合有歷史紀錄需求或想重複使用相同行程模板的使用者。

**Independent Test**: 使用者將「2025 日本行」複製為「2026 日本行」，選擇「清空勾選狀態」後，新行程保留所有購買項目但全部標記為「未完成」。

**Acceptance Scenarios**:

1. **Given** 使用者的「2025 東京行」已結束，購買清單有 10 個項目（7 個已完成）  
   **When** 行程標記為「已結束」  
   **Then** 購買清單完整保留，不會自動清除或隱藏

2. **Given** 使用者想複製「2025 東京行」作為「2026 東京行」的範本  
   **When** 點擊「複製行程」並選擇「保留購買項目，清空勾選狀態」  
   **Then** 新行程包含相同的 10 個購買項目，但全部標記為「未完成」

3. **Given** 使用者複製行程時選擇「完整複製（含勾選狀態）」  
   **When** 查看新行程的購買清單  
   **Then** 新行程的項目和勾選狀態與原行程完全一致

---

### Edge Cases

- **多人同時新增同名項目**：使用者 A 和 B 同時新增「珍珠奶茶」，系統應保留兩筆獨立項目（各有唯一 ID），不應合併或覆蓋。

- **網路延遲導致順序錯亂**：使用者 A 依序勾選 3 個項目，但因網路延遲，伺服器收到的順序是 3→1→2。系統應以各操作的時間戳為準，確保最終狀態正確。

- **離線期間新增項目後，另一使用者刪除該卡片**：使用者 A 離線狀態下在「台北101」新增項目，使用者 B 刪除了整個「台北101」卡片。當 A 恢復連線時，系統應提示「該卡片已被刪除，離線新增的項目無法同步」。

- **超大購買清單（100+ 項目）**：單一卡片的購買清單超過 100 項時，UI 應支援分頁或虛擬滾動，確保效能不受影響。

- **項目名稱包含特殊字元**：使用者輸入「買 <script>alert('XSS')</script>」作為項目名稱，系統應正確轉義顯示，不執行腳本。

- **同時刪除與勾選同一項目**：使用者 A 勾選「茶葉」為已完成，使用者 B 同時刪除「茶葉」。系統應以時間戳較新的操作為準，若刪除較新，則忽略勾選操作。

## Requirements *(mandatory)*

### Functional Requirements

#### 基本功能（P1）

- **FR-001**: 系統必須在每一行程卡片中提供「購買清單」區塊，預設摺疊，點擊後展開
- **FR-002**: 使用者必須能在購買清單中新增項目，輸入項目名稱後立即保存
- **FR-003**: 使用者必須能點擊項目文字或勾選框來切換完成狀態（已完成↔未完成）
- **FR-004**: 系統必須即時儲存勾選狀態至持久化儲存（LocalStorage 或雲端資料庫）
- **FR-005**: 使用者必須能刪除購買項目（權限允許範圍內）
- **FR-006**: 系統必須明確區分「已完成」與「未完成」項目的視覺呈現（如刪除線、變灰、勾選符號）
- **FR-007**: 系統必須提供「僅顯示未完成」的過濾檢視模式
- **FR-008**: 購買清單操作必須適合行動裝置，點擊目標不小於 44×44 像素

#### 多人協作功能（P1）

- **FR-009**: 系統必須支援多位使用者同時存取和編輯同一行程的購買清單
- **FR-010**: 任一使用者的購買清單操作必須在 3 秒內同步至其他使用者畫面
- **FR-011**: 系統必須記錄每個購買項目的最後更新使用者和時間戳
- **FR-012**: 當多位使用者同時操作同一項目時，系統必須以時間戳較新的操作為準
- **FR-013**: 系統必須提供衝突解決機制，當檢測到操作衝突時通知使用者

#### 詳細資訊功能（P2）

- **FR-014**: 購買項目必須至少包含以下欄位：項目名稱（必填）、完成狀態（必填）、備註（選填）、數量（選填）、預估金額（選填）
- **FR-015**: 使用者必須能編輯已存在的購買項目資訊
- **FR-016**: 系統必須自動計算並顯示購買清單的「預估總金額」
- **FR-017**: 金額欄位必須支援常見幣別（至少包含 TWD、JPY、USD、EUR）

#### 離線與同步功能（P2）

- **FR-018**: 系統必須支援離線狀態下進行購買項目的新增、勾選、編輯操作
- **FR-019**: 離線期間的操作必須暫存於本地，網路恢復後自動同步至伺服器
- **FR-020**: 同步過程中若發生衝突，系統必須以時間戳較新的操作為準
- **FR-021**: 離線操作時，UI 必須明確標示「離線模式」，並提示「將於連線後同步」
- **FR-022**: 同步完成後，系統必須通知使用者「已與伺服器同步」

#### 權限與角色功能（P3）

- **FR-023**: 系統必須定義「行程擁有者（Owner）」和「行程參與者（Member）」兩種角色
- **FR-024**: 行程擁有者必須具備購買清單的完整管理權限（新增、編輯、刪除任何項目）
- **FR-025**: 行程參與者必須能新增和勾選購買項目，但只能刪除自己新增的項目
- **FR-026**: 系統架構必須支援未來擴充更多角色（如「僅檢視者」），無需大幅修改核心代碼

#### 資料保留與複製功能（P3）

- **FR-027**: 行程結束後，購買清單及其勾選紀錄必須完整保留，不得自動刪除
- **FR-028**: 系統必須支援複製行程功能，複製時可選擇「保留購買項目，清空勾選狀態」或「完整複製（含勾選狀態）」
- **FR-029**: 複製行程時，購買項目的 ID 必須重新生成，確保與原行程獨立

### Key Entities

- **ShoppingList（購買清單）**：隸屬於特定行程卡片，包含多個購買項目
  - `itineraryItemId`: 所屬行程卡片 ID
  - `items`: 購買項目陣列
  - `totalEstimatedAmount`: 預估總金額（自動計算）

- **ShoppingItem（購買項目）**：購買清單中的單一項目
  - `id`: 唯一識別碼（UUID）
  - `name`: 項目名稱（必填）
  - `isCompleted`: 完成狀態（已完成／未完成）
  - `note`: 備註（選填）
  - `quantity`: 數量（選填）
  - `estimatedAmount`: 預估金額（選填）
  - `currency`: 幣別（選填，預設 TWD）
  - `createdBy`: 創建使用者
  - `createdAt`: 創建時間
  - `lastUpdatedBy`: 最後更新使用者
  - `lastUpdatedAt`: 最後更新時間

- **User（使用者）**：操作購買清單的使用者
  - `id`: 使用者 ID
  - `role`: 角色（Owner / Member）
  - `displayName`: 顯示名稱

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者能在 5 秒內完成新增購買項目並勾選完成的完整流程
- **SC-002**: 多人協作時，購買項目狀態變更能在 3 秒內同步至其他使用者畫面
- **SC-003**: 系統在離線狀態下仍能正常操作購買清單，網路恢復後 10 秒內完成同步
- **SC-004**: 95% 的使用者能在首次使用時，不需要額外說明即可成功新增和勾選購買項目
- **SC-005**: 購買清單支援至少 100 個項目，載入和操作時間不超過 2 秒
- **SC-006**: 行動裝置上，使用者能單手操作購買清單的所有功能（點擊目標 ≥ 44×44 像素）
- **SC-007**: 多人同時操作時，衝突發生率低於 1%，且 100% 的衝突能正確解決（採用時間戳較新者）
- **SC-008**: 行程複製功能能正確保留購買項目並按使用者選擇清空或保留勾選狀態

## Assumptions

- 使用者已完成登入驗證，系統能識別使用者身份
- 現有行程卡片架構支援擴充「購買清單」子功能
- 系統具備基本的即時通訊或輪詢機制（如 WebSocket、Server-Sent Events 或定期 polling）以支援多人同步
- 使用者裝置支援 LocalStorage 或 IndexedDB 用於離線儲存
- Google Sheet 或其他資料來源支援讀寫操作（非僅唯讀）
- 使用者願意接受「最後寫入優先」的衝突解決策略

## Out of Scope

- **推播通知**：當其他成員操作購買清單時，不提供手機推播通知（未來可考慮）
- **項目分類與標籤**：購買項目不支援分類（如「紀念品」、「食品」）或多標籤功能
- **照片上傳**：購買項目不支援附加照片（僅支援文字備註）
- **價格追蹤**：不提供實際購買金額記錄與預算對比功能（僅支援預估金額）
- **AI 推薦**：不提供基於地點或歷史的購買建議
- **匯出清單**：不支援匯出購買清單為 PDF 或 Excel
- **語音輸入**：不支援語音新增購買項目
- **項目排序**：購買項目按新增時間排序，不支援手動拖曳排序

## Constraints

- **技術約束**：需使用現有前端框架（Vue 3 + TypeScript），不引入新的後端服務（僅使用 Google Sheets API 或 LocalStorage）
- **效能約束**：單一卡片的購買清單不應超過 200 個項目，避免影響 UI 效能
- **資料同步延遲**：使用 Google Sheets API 時，同步延遲可能達 2-5 秒，需向使用者明確說明
- **離線儲存限制**：瀏覽器 LocalStorage 限制為 5-10 MB，購買清單資料需壓縮儲存
- **無專用後端**：由於採用純前端架構，多人協作功能依賴 Google Sheets API 的讀寫機制，可能有 API 配額限制
- **權限管理簡化**：角色與權限基於登入密碼判斷，無法實現細緻的使用者權限管理（如個別設定某使用者為唯讀）

## Future Enhancements

- **項目分類與過濾**：支援將購買項目分類（紀念品、食品、服飾等），並按分類過濾顯示
- **照片附件**：允許為購買項目附加照片（商品照片、店面照片等）
- **實際花費記錄**：支援記錄實際購買金額，並與預估金額對比，產生預算報表
- **推播通知**：當其他成員新增或勾選項目時，推送通知至手機
- **語音輸入**：支援語音新增購買項目，提升行動裝置使用體驗
- **AI 購買建議**：根據行程地點和歷史購買紀錄，推薦可能需要購買的項目
- **匯出與分享**：支援將購買清單匯出為 PDF 或 Excel，並透過連結分享給非行程成員
- **手動排序**：支援拖曳調整購買項目順序，方便規劃購買路線
- **採購責任人**：為每個購買項目指定負責人，明確分工
- **整合地圖**：將購買項目與店家位置整合，顯示在地圖上
