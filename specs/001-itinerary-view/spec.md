# 功能規格：旅遊行程檢視網站（itinerary-view）

**功能分支**: `[001-itinerary-view]`  
**建立日期**: 2025-12-05  
**狀態**: 草案  
**輸入**: 使用者描述（摘要）：
「Google Sheet 匯入與快取、RWD、Emoji/卡片式 UX、免費部署（GitHub Pages/Cloudflare/Vercel），Loading、錯誤提示、PWA(選)、SEO(選)、Deep Link、權限安全。」

## Clarifications

### Session 2025-12-05

- Q: Google Sheet 取用策略（公開 vs API vs 代理 vs 靜態）？ → A: 使用「公開可讀」Google Sheet，前端以 CSV/JSON 直連取用（無需金鑰）。
- Q: 欄位異動容錯策略？ → A: 採用「欄位映射表（版本化）＋寬鬆解析」，未知欄位忽略並記錄告警。
- Q: PWA 快取範圍？ → A: 快取 CSS/JS/字型 + 首屏必要 JSON。
- Q: SEO 層級？ → A: 基礎 Open Graph + meta（title/description/image）。
- Q: 深連結格式？ → A: `?date=YYYY-MM-DD&item=<slug>`（同時支援僅日期 `?date=...`）。
- Q: 首次進入網站時，系統應顯示哪一天的行程？ → A: 當日行程（若存在），否則顯示行程第一天。
- Q: 選定日期完全無行程時，應如何顯示？ → A: 顯示空狀態卡片，提示「此日無安排行程」並提供快速跳轉按鈕（前一天／後一天）。
- Q: 搜尋功能應採用即時搜尋（輸入時即時篩選）或按鈕提交方式？ → A: 即時搜尋（輸入 300ms 防抖後自動篩選）。
- Q: 標籤系統的來源與過濾邏輯為何？ → A: 預定義標籤清單（從 Google Sheet 統計自動生成），多標籤 OR 邏輯（任一符合即顯示）。
- Q: PWA 離線模式下，使用者能否查看已快取的舊資料？ → A: 允許查看已快取資料，並於頂部顯示「離線模式：顯示快取資料」橫幅提示。

## 使用者情境與測試（必填）

<!--
  IMPORTANT: User stories should be PRIORITIZED as user journeys ordered by importance.
  Each user story/journey must be INDEPENDENTLY TESTABLE - meaning if you implement just ONE of them,
  you should still have a viable MVP (Minimum Viable Product) that delivers value.
  
  Assign priorities (P1, P2, P3, etc.) to each story, where P1 is the most critical.
  Think of each story as a standalone slice of functionality that can be:
  - Developed independently
  - Tested independently
  - Deployed independently
  - Demonstrated to users independently
-->

### 使用者故事 1 — 檢視每日行程（優先級：P1）

使用者於網站選擇某日期後，可清楚看到該日的行程卡片（景點、餐廳、交通、住宿、時間、備註），並可左右切換不同日期。

**為何此優先級**：為網站核心價值；即使只有每日行程顯示也能形成最小可用產品（MVP）。

**獨立測試**：
- 以公開的測試 Google Sheet 載入行程 → 成功渲染卡片 → 可切換到相鄰日期。
- 於手機與桌機檢視皆清晰可讀且版面不破版。

**驗收情境**：
1. **Given** 有效的 Google Sheet 來源，**When** 使用者選擇日期，**Then** 顯示該日卡片式行程，含 Emoji 與關鍵資訊。
2. **Given** 多天行程，**When** 使用者左右滑動或切換頁籤，**Then** 正確切換至相鄰日期且內容一致。

---

### 使用者故事 2 — 搜尋／過濾行程（優先級：P2）

使用者可輸入關鍵字或選擇分類（景點／餐廳／交通／住宿）以篩選清單，快速找到目標資訊。

**為何此優先級**：提升可發現性與效率，屬次要但常用的操作。

**獨立測試**：
- 載入資料後，輸入關鍵字「美食」→ 僅顯示符合餐廳或備註包含美食的卡片。

**驗收情境**：
1. **Given** 已載入行程資料，**When** 使用者輸入關鍵字或選擇分類，**Then** 僅顯示符合條件的卡片並保留日期切換功能。

---

### 使用者故事 3 — 分享與深連結（優先級：P3）

使用者可分享網址，朋友開啟後直接落在特定日期或特定行程卡片。

**為何此優先級**：提升社群擴散與溝通效率。

**獨立測試**：
- 直接開啟帶有 `?date=YYYY-MM-DD` 的網址 → 頁面定位至該日期。

**驗收情境**：
1. **Given** 有深連結參數，**When** 使用者開啟頁面，**Then** 自動切換並定位至對應日期／行程卡片。

---

### 使用者故事 4 — 檢視旅遊資訊（優先級：P2）

使用者可切換至「旅遊資訊」頁籤，查看行程外的補充資訊（如：攜帶物品清單、旅遊注意事項、緊急聯絡人、預算總覽等），並可依分類快速定位。

**為何此優先級**：旅遊規劃常需額外資訊（物品清單避免遺漏、注意事項提醒風險），提升行程準備完整性；獨立頁籤避免干擾每日行程檢視，屬重要但非核心流程。

**獨立測試**：
- 點擊「旅遊資訊」頁籤 → 顯示物品清單與注意事項 → 可依分類（攜帶物品／注意事項／緊急聯絡／預算）過濾。
- 於手機與桌機檢視皆清晰可讀。

**驗收情境**：
1. **Given** 已載入旅遊資訊資料，**When** 使用者點擊「旅遊資訊」頁籤，**Then** 顯示分類清單與內容卡片。
2. **Given** 旅遊資訊包含多個分類，**When** 使用者選擇特定分類（如：攜帶物品），**Then** 僅顯示該分類的資訊項目。
3. **Given** 物品清單項目，**When** 使用者勾選已準備項目，**Then** 視覺標示已完成（打勾／劃線）並於下次載入時保留狀態。

---

### 邊界情境

<!--
  ACTION REQUIRED: The content in this section represents placeholders.
  Fill them out with the right edge cases.
-->

- Google Sheet 欄位異動：新增欄位或重新命名時系統不應崩潰，應以容錯策略忽略未知欄位或採用映射表。
  - （Clarified）以「版本化欄位映射表」定義已知欄位，未知欄位忽略並記錄告警以便後續調整。
- 取用失敗：顯示友善錯誤訊息與重新嘗試按鈕。
- 大量資料：分頁或惰性載入以避免一次載入過多造成卡頓。
- 搜尋效能：即時搜尋採用 300ms 防抖避免過度渲染；若資料量超過 500 項建議前端建立索引或考慮虛擬滾動。
- 標籤統計與更新：標籤清單於資料載入時統計生成並快取；當行程資料更新時重新統計；若無任何行程包含標籤則不顯示標籤過濾區塊。
- 行動裝置極小螢幕：字體最小值與卡片排版需保持可讀性。
- 當日無行程或超出範圍：首次進入時若當日不在行程範圍內（行程開始前或結束後），預設顯示行程第一天；若完全無行程資料則顯示空狀態提示。
- 選定日期無行程：顯示空狀態卡片（圖示＋「此日無安排行程」文字）與前後日快速跳轉按鈕；若該日為行程首日或末日則僅顯示單向跳轉。
- 欄位缺失／部分資訊：卡片應優雅降級顯示，僅顯示已提供欄位；若關鍵資訊（標題、分類）缺失則標示錯誤但不影響其他卡片。
- 多幣別與價格顯示：若行程橫跨多國或多幣別，系統應清楚標示幣別（如：TWD 1,200、JPY 3,000）避免混淆。
- 完成狀態同步：`isCompleted` 狀態儲存於本地（LocalStorage），不影響 Google Sheet 原始資料；跨裝置不同步。
- 離線模式降級：PWA 離線時允許查看快取資料並保留所有瀏覽功能（日期切換、搜尋、過濾），但停用重新整理功能並顯示橫幅提示；恢復網路後自動隱藏橫幅並啟用更新功能。
- 旅遊資訊空資料：若 Google Sheet 無提供旅遊資訊資料，顯示空狀態提示「暫無旅遊資訊」並隱藏分類過濾區塊；若僅部分分類有資料則僅顯示有資料的分類。
- 物品清單完成狀態：勾選狀態儲存於本地（LocalStorage），與行程完成狀態使用相同鍵命名空間隔離；跨裝置不同步。

## 需求（必填）

<!--
  ACTION REQUIRED: The content in this section represents placeholders.
  Fill them out with the right functional requirements.
-->

### 功能性需求

- **FR-001**：系統必須能從指定 Google Sheet 讀取行程資料並轉為前端可用結構。
- （Clarified）資料來源採「公開可讀」Google Sheet，前端以 CSV/JSON 直連；若改用 API/代理須更新安全策略與部署設計。
- **FR-002**：系統必須具備快取／更新機制以反映最新資料（至少提供手動重新整理）。
  - （Clarified）快取層需保存目前映射版本號，當偵測欄位異動時以寬鬆解析回退；於研究/計畫定義升版流程。
- **FR-003**：使用者必須能依日期切換檢視每日行程卡片（含 Emoji 與一致排版）。
  - （Clarified）首次進入時，系統顯示當日行程（若存在於行程範圍內）；若當日無行程或超出範圍，則預設顯示行程第一天。
  - （Clarified）選定日期若無行程項目，顯示空狀態卡片（提示「此日無安排行程」）並提供前一天／後一天快速跳轉按鈕。
- **FR-003-1**：系統必須能將餐廳分類為早餐🌅、午餐☀️、晚餐🌙三個時段，並於卡片與過濾介面清楚標示。
- **FR-003-2**：餐廳名稱必須提供超連結，點擊後開啟 Google Maps app（行動裝置）或網頁版（桌機）以顯示店家位置與資訊。
- **FR-004**：系統必須提供關鍵字搜尋與分類過濾（景點／餐廳／交通／住宿）。
  - （Clarified）搜尋採即時搜尋模式，輸入關鍵字後 300ms 防抖自動篩選結果；分類過濾點擊即生效。
- **FR-005**：系統必須支援 RWD，於手機／平板／桌機皆能清晰顯示（含橫直向）。
- **FR-006**：系統必須提供 Loading 狀態與取用失敗的錯誤提示。
- **FR-007**：系統必須支援以網址參數（Deep Link）直接開啟特定日期或行程。
  - （Clarified）深連結格式採 `?date=YYYY-MM-DD&item=<slug>`；若僅提供 `date` 則定位至該日；僅提供 `item` 則推導其所屬日期。
- **FR-008**：系統應該可免費部署於常見平台（GitHub Pages／Cloudflare Pages／Vercel）。
- **FR-009**：系統應該提供基本 PWA 快取（至少 CSS/JS），以改善弱網體驗。
  - （Clarified）快取清單包含 CSS、JS、字型資源與「首屏必要 JSON」；採用版本化快取名稱與更新策略避免舊資源殘留。
  - （Clarified）離線模式下允許查看已快取的行程資料，並於頁面頂部顯示橫幅提示「離線模式：顯示快取資料（最後更新：YYYY-MM-DD HH:mm）」；重新整理按鈕於離線時停用並標示「需網路連線」。
- **FR-010**：系統必須以只讀方式安全取用 Google Sheet（公開或 API Key），避免在前端暴露敏感金鑰。
- **FR-012**：系統必須支援圖片顯示：卡片可包含圖片縮圖／連結，並具備載入中占位、失敗替代圖、Lazy Load 與基本快取策略。
- **FR-013**：系統必須能顯示行程項目的詳細資訊欄位（聯絡電話、營業時間、預約狀態、費用明細、交通細節、住宿細節等），並根據分類（景點／餐廳／交通／住宿）動態顯示相關欄位。
- **FR-014**：系統應該支援標籤過濾與顯示（如：必訪、美食推薦、親子友善），使用者可依標籤快速篩選行程。
  - （Clarified）標籤清單由系統自動從 Google Sheet 所有行程項目的 `tags` 欄位統計生成（去重排序）；過濾採 OR 邏輯（任一選中標籤符合即顯示該行程項目）。
- **FR-015**：系統應該顯示評分資訊（星級或數值）與評分來源，協助使用者判斷行程優先順序。
- **FR-016**：系統應該提供參考連結列表（官網、訂票連結、遊記），點擊後於新分頁開啟。
- **FR-017**：系統應該支援行程完成狀態勾選（`isCompleted`），並於卡片視覺上標示（如：打勾圖示、灰階處理）。
- **FR-018**：系統必須提供「旅遊資訊」獨立頁籤，顯示行程外的補充資訊（攜帶物品清單、注意事項、緊急聯絡人、預算總覽等）。
- **FR-019**：系統必須支援旅遊資訊分類過濾（攜帶物品／注意事項／緊急聯絡／預算／其他），使用者可快速定位目標資訊。
- **FR-020**：系統應該支援物品清單項目勾選（`isPacked`），並於卡片視覺上標示已準備狀態（如：打勾圖示、劃線），勾選狀態儲存於本地（LocalStorage）。
- **FR-021**：旅遊資訊資料必須從同一 Google Sheet 的獨立工作表（Sheet）讀取，或從指定的第二個 Google Sheet 讀取（於設定中指定）。

*不清楚但需標記：*
- **FR-011**：SEO 層級採「基礎 Open Graph + meta（title/description/image）」；結構化資料、站點地圖與語系標註暫不納入（如後續需要，於計畫階段升級）。

### 關鍵實體（涉及資料時）

- **ItineraryDay**：代表每日行程；屬性：日期、卡片列表（景點／餐廳／交通／住宿）、備註。
- **ItineraryItem**：代表單一卡片；屬性包含：
  - **基本資訊**：標題、分類（景點／餐廳／交通／住宿）、時間段、Emoji
  - **位置相關**：位置名稱、`googleMapsUrl`（可選，建議餐廳必填；點擊開啟 Google Maps app 或網頁版）
  - **聯絡資訊**：`phoneNumber`（可選，適用餐廳／飯店）、`website`（可選，官網連結）
  - **時間資訊**：`openingHours`（可選，營業／開放時間）、`checkInTime`／`checkOutTime`（可選，僅住宿類別）
  - **費用相關**：`cost`（金額）、`currency`（幣別，預設 TWD）、`pricePerPerson`（是否為單人價）、`paymentStatus`（可選：已付款／待付款／現場付款）
  - **預約資訊**：`reservationStatus`（可選：已預約／待預約／免預約）、`confirmationNumber`（可選，預約／訂單編號）
  - **交通細節**（僅交通類別）：`transportType`（火車／高鐵／巴士／計程車／租車等）、`ticketNumber`（可選，車次／班次）、`seatNumber`（可選，座位號）
  - **住宿細節**（僅住宿類別）：`roomType`（可選，房型）、`address`（可選，詳細地址）
  - **餐廳細節**（僅餐廳類別）：`mealTime`（早餐🌅／午餐☀️／晚餐🌙）
  - **標籤與評分**：`tags`（可選，陣列如：["必訪", "美食推薦", "親子友善"]）、`rating`（可選，1-5 星或數值）、`ratingSource`（可選，評分來源如 Google／個人）
  - **多媒體與參考**：`imageUrl`（可選）、`imageAlt`（可選）、`referenceLinks`（可選，陣列，參考連結如部落格遊記／訂票網址）
  - **備註與狀態**：`notes`（備註）、`isCompleted`（可選，是否已完成此行程項目）

- **TravelInfo**：代表旅遊資訊頁籤的整體資料；屬性：資訊項目列表（依分類分組）、最後更新時間。
- **InfoItem**：代表單一旅遊資訊項目；屬性包含：
  - **基本資訊**：標題、分類（攜帶物品／注意事項／緊急聯絡／預算／其他）、內容描述、Emoji（可選）
  - **物品清單專屬**（僅攜帶物品分類）：`isPacked`（可選，是否已準備）、`quantity`（可選，數量如「2 件」）、`priority`（可選，優先級如：必備／建議／可選）
  - **聯絡資訊專屬**（僅緊急聯絡分類）：`contactName`（聯絡人姓名）、`phoneNumber`（電話）、`relationship`（關係如：旅伴／緊急聯絡人／當地導遊）
  - **預算專屬**（僅預算分類）：`amount`（金額）、`currency`（幣別，預設 TWD）、`category`（預算類別如：交通／住宿／餐飲／門票／購物／其他）
  - **多媒體與參考**：`imageUrl`（可選）、`referenceLinks`（可選，陣列）
  - **備註與排序**：`notes`（備註）、`sortOrder`（排序權重，數值越小越前）

## 成功準則（必填）

<!--
  ACTION REQUIRED: Define measurable success criteria.
  These must be technology-agnostic and measurable.
-->

### 可衡量成果

- **SC-001**：首次載入主頁在常見桌機網路下可於 2 秒內完成可視內容渲染；行動裝置 3 秒內。
- **SC-002**：使用者可在 1 秒內完成日期切換並看到對應行程卡片。
- **SC-003**：90% 使用者能在首次使用時成功找到目標日期並瀏覽卡片內容。
- **SC-004**：行程資料更新後，使用者在 5 分鐘內可透過快取更新或重新整理看到最新內容。
- **SC-005**：錯誤場景下顯示明確訊息與重試入口；相關回報（支持訊息）低於初期每月 5 件。
- **SC-006**：含圖片的行程卡片在常見網路下可於 3 秒內顯示首張圖片縮圖；圖片載入失敗時顯示替代圖而不影響卡片其他資訊瀏覽。
- **SC-007**：卡片能根據分類（景點／餐廳／交通／住宿）動態顯示專屬欄位（如：餐廳顯示營業時間與電話、交通顯示車次座位），使用者可在 3 秒內識別關鍵資訊。
- **SC-008**：使用者可在 2 次點擊內完成標籤過濾操作並看到篩選結果。
- **SC-009**：完成狀態（`isCompleted`）勾選後立即反映於卡片視覺（如：打勾圖示），並於下次載入時保留狀態。
- **SC-010**：使用者可在 2 次點擊內切換至「旅遊資訊」頁籤並查看分類清單。
- **SC-011**：物品清單項目勾選後立即反映於視覺（如：打勾圖示、劃線），並於下次載入時保留狀態；已準備項目數／總項目數顯示於分類標題（如：「攜帶物品 (8/15)」）。
